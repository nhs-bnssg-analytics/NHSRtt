<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating and validating a model • NHSRtt</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating and validating a model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NHSRtt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/rtt-pipeline.html">Creating and validating a model</a></li>
    <li><a class="dropdown-item" href="../articles/animated-charts.html">Visualising projections</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Creating and validating a model</h1>
            
      

      <div class="d-none name"><code>rtt-pipeline.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nhs-bnssg-analytics.github.io/NHSRtt/">NHSRtt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span></span></code></pre></div>
<p>This vignette provides a walkthrough for how to use the NHSRtt
package.</p>
<p>The vignette shows:</p>
<ol style="list-style-type: decimal">
<li>how the data are set up</li>
<li>how the renege and capacity parameters are calculated</li>
<li>how the parameter performance can be validated</li>
<li>how the parameters can be applied to future scenarios</li>
</ol>
<div class="section level2">
<h2 id="aims">Aims<a class="anchor" aria-label="anchor" href="#aims"></a>
</h2>
<p>The aim of the exercise in this vignette is, for a selected acute
trust, to predict future activity, and hence waiting times, for all
elective activity at that trust.</p>
<p>This is done by developing some model parameters, based on a
stock-and-flow approach over a time period (called the calibration
period). These parameters are calculated from publicly available data,
which are counts of incomplete pathways, completed pathways and new
referrals at each time step. The completed and incomplete pathways are
broken down into the number of months the individuals in the pathways
have been waiting.</p>
<p>These parameters are then applied to a subsequent time period (called
the validation period). The parameters are used to generate estimated
incomplete activity for this period. This activity is compared with the
observed activity to evaluate the modelling.</p>
<p>The final part is to apply the model parameters to some future
scenarios to predict future waiting times.</p>
</div>
<div class="section level2">
<h2 id="setting-up-the-data">Setting up the data<a class="anchor" aria-label="anchor" href="#setting-up-the-data"></a>
</h2>
<p>Conceptually, we want to use a year of data to calibrate parameters,
and then the following six months to validate those parameters. We will
then use these parameters to predict for the year following the
valdiation period.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">calibration_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2023-05-01"</span><span class="op">)</span></span>
<span><span class="va">calibration_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-04-30"</span><span class="op">)</span></span>
<span><span class="va">validation_start</span> <span class="op">&lt;-</span> <span class="va">calibration_end</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">validation_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-10-31"</span><span class="op">)</span></span>
<span><span class="va">prediction_start</span> <span class="op">&lt;-</span> <span class="va">validation_end</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">prediction_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2025-10-31"</span><span class="op">)</span></span>
<span><span class="va">analysis_trust</span> <span class="op">&lt;-</span> <span class="st">"RC9"</span> <span class="co"># filter for a single trust</span></span>
<span><span class="va">max_months_waited</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="co"># I am only interested in waiting time bins up to 12 months</span></span></code></pre></div>
<p><img src="rtt-pipeline_files/figure-html/visualise-analysis-timings-1.png" width="672"></p>
<p>The public data(<a href="https://www.england.nhs.uk/statistics/statistical-work-areas/rtt-waiting-times/" class="external-link">source</a>)
can be sourced with the <code><a href="../reference/get_rtt_data.html">get_rtt_data()</a></code> function. The data
we are interested from the website are the pathways that are admitted
and non-admitted (these are considered completed pathways), incomplete
(these are people who are still waiting to be admitted), and new RTT
periods (these are new referrals that are entering the referral to
treatment pathway). To specify which dataset to download, the
<code>type</code> argument is set to one of “complete”, “incomplete” or
“referral”. The data are provided by specialty and trust, so can be
aggregated depending on the analysis of interest.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># each metric must be downloaded separately</span></span>
<span><span class="va">completes</span> <span class="op">&lt;-</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="../reference/get_rtt_data.html">get_rtt_data</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"complete"</span>,</span>
<span>  date_start <span class="op">=</span> <span class="va">calibration_start</span>,</span>
<span>  date_end <span class="op">=</span> <span class="va">validation_end</span>,</span>
<span>  show_progress <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># can change this to TRUE to see progress</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">incompletes</span> <span class="op">&lt;-</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="../reference/get_rtt_data.html">get_rtt_data</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"incomplete"</span>,</span>
<span>  date_start <span class="op">=</span> <span class="va">calibration_start</span>,</span>
<span>  date_end <span class="op">=</span> <span class="va">validation_end</span>,</span>
<span>  show_progress <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># can change this to TRUE to see progress</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">referrals</span> <span class="op">&lt;-</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="../reference/get_rtt_data.html">get_rtt_data</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"referral"</span>,</span>
<span>  date_start <span class="op">=</span> <span class="va">calibration_start</span>,</span>
<span>  date_end <span class="op">=</span> <span class="va">validation_end</span>,</span>
<span>  show_progress <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># can change this to TRUE to see progress</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here is what the first 15 rows of data for the completes object looks
like when it comes out of the <code><a href="../reference/get_rtt_data.html">get_rtt_data()</a></code> function (this
may change if this is run on a different date as the data update
monthly):</p>
<table class="table">
<caption>Example completes data set following the download from the NHS
website.</caption>
<thead><tr class="header">
<th align="left">trust</th>
<th align="left">specialty</th>
<th align="left">period</th>
<th align="left">months_waited</th>
<th align="left">type</th>
<th align="right">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">&lt;1</td>
<td align="left">Admitted</td>
<td align="right">32.285714</td>
</tr>
<tr class="even">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">1-2</td>
<td align="left">Admitted</td>
<td align="right">33.428571</td>
</tr>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">2-3</td>
<td align="left">Admitted</td>
<td align="right">18.571429</td>
</tr>
<tr class="even">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">3-4</td>
<td align="left">Admitted</td>
<td align="right">15.714286</td>
</tr>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">4-5</td>
<td align="left">Admitted</td>
<td align="right">4.000000</td>
</tr>
<tr class="even">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">5-6</td>
<td align="left">Admitted</td>
<td align="right">8.285714</td>
</tr>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">6-7</td>
<td align="left">Admitted</td>
<td align="right">3.857143</td>
</tr>
<tr class="even">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">7-8</td>
<td align="left">Admitted</td>
<td align="right">10.857143</td>
</tr>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">8-9</td>
<td align="left">Admitted</td>
<td align="right">4.285714</td>
</tr>
<tr class="even">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">9-10</td>
<td align="left">Admitted</td>
<td align="right">5.285714</td>
</tr>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">10-11</td>
<td align="left">Admitted</td>
<td align="right">8.428571</td>
</tr>
<tr class="even">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">11-12</td>
<td align="left">Admitted</td>
<td align="right">7.285714</td>
</tr>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">12-13</td>
<td align="left">Admitted</td>
<td align="right">5.714286</td>
</tr>
<tr class="even">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">13-14</td>
<td align="left">Admitted</td>
<td align="right">3.000000</td>
</tr>
<tr class="odd">
<td align="left">R1H</td>
<td align="left">C_100</td>
<td align="left">2024-10-01</td>
<td align="left">14-15</td>
<td align="left">Admitted</td>
<td align="right">5.428571</td>
</tr>
</tbody>
</table>
<p>For the purposes of this vignette, where we are performing the
analysis on all activity (rather than by specialty), we append and
aggregate the data before splitting it out again later into three
datasets. The data manipulation here takes five steps:</p>
<ol style="list-style-type: decimal">
<li>filter for the trust of interest</li>
<li>change the “type” column into “Complete”, “Incomplete” and
“Referrals”</li>
<li>convert the months_waited string into an id using the
<code><a href="../reference/convert_months_waited_to_id.html">convert_months_waited_to_id()</a></code> function</li>
<li>aggregate all the counts by specialty into one overall figure</li>
<li>create a “period_id” numeric field for the sequential months in the
dataset</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">monthly_rtt</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">completes</span>,</span>
<span>  <span class="va">incompletes</span>,</span>
<span>  <span class="va">referrals</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">trust</span> <span class="op">==</span> <span class="va">analysis_trust</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Non-Admitted"</span> <span class="op">~</span> <span class="st">"Complete"</span>,</span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Admitted"</span> <span class="op">~</span> <span class="st">"Complete"</span>,</span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"New Periods"</span> <span class="op">~</span> <span class="st">"Referrals"</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">type</span></span>
<span>    <span class="op">)</span>,</span>
<span>    months_waited_id <span class="op">=</span> <span class="fu"><a href="../reference/convert_months_waited_to_id.html">convert_months_waited_to_id</a></span><span class="op">(</span></span>
<span>      <span class="va">months_waited</span>,</span>
<span>      <span class="va">max_months_waited</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">trust</span>,</span>
<span>      <span class="va">period</span>,</span>
<span>      <span class="va">type</span>,</span>
<span>      <span class="va">months_waited_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span>,</span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">period</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    period_id <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># we need period_id for later steps</span></span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">type</span>,</span>
<span>      <span class="va">months_waited_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Example few records from the monthly_rtt object.</caption>
<thead><tr class="header">
<th align="left">trust</th>
<th align="left">period</th>
<th align="left">type</th>
<th align="right">months_waited_id</th>
<th align="right">value</th>
<th align="right">period_id</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">RC9</td>
<td align="left">2023-05-01</td>
<td align="left">Complete</td>
<td align="right">0</td>
<td align="right">1413.429</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">RC9</td>
<td align="left">2023-06-01</td>
<td align="left">Complete</td>
<td align="right">0</td>
<td align="right">1429.429</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">RC9</td>
<td align="left">2023-07-01</td>
<td align="left">Complete</td>
<td align="right">0</td>
<td align="right">1484.571</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">RC9</td>
<td align="left">2023-08-01</td>
<td align="left">Complete</td>
<td align="right">0</td>
<td align="right">1384.857</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">RC9</td>
<td align="left">2023-09-01</td>
<td align="left">Complete</td>
<td align="right">0</td>
<td align="right">1570.286</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">RC9</td>
<td align="left">2023-10-01</td>
<td align="left">Complete</td>
<td align="right">0</td>
<td align="right">1558.857</td>
<td align="right">6</td>
</tr>
</tbody>
</table>
<p>The data need to be in a specific format (as described by the
function documentation) for the functions to work.</p>
<p>To calculate the renege and capacity parameters, the inputs you needs
are:</p>
<ol style="list-style-type: decimal">
<li>Referrals per time step (these are inputs to each time step), where
all referrals have waited 0 months</li>
<li>Complete pathways per time step by the number of months waited</li>
<li>Incomplete pathways per time step by the number of months
waited</li>
</ol>
<p>Here, we split the data out again into three objects (completes,
incompletes and referrals)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">calibration_period</span> <span class="op">&lt;-</span> <span class="va">monthly_rtt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span></span>
<span>      <span class="va">period</span>,</span>
<span>      <span class="va">calibration_start</span>,</span>
<span>      <span class="va">calibration_end</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">trust</span>,</span>
<span>      <span class="va">period_id</span>,</span>
<span>      <span class="va">type</span>,</span>
<span>      <span class="va">months_waited_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">trust</span>,</span>
<span>    <span class="va">period_id</span>,</span>
<span>    <span class="va">type</span>,</span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">referrals</span> <span class="op">&lt;-</span> <span class="va">calibration_period</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Referrals"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    referrals <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Example referrals data set.</caption>
<thead><tr class="header">
<th align="right">period_id</th>
<th align="right">referrals</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">35380</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">36790</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">35216</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">35380</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">35974</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">36914</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">39022</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">31528</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">38668</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">38112</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">37422</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">36730</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">completes</span> <span class="op">&lt;-</span> <span class="va">calibration_period</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Complete"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span>,</span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    treatments <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Example completes data set.</caption>
<thead><tr class="header">
<th align="right">period_id</th>
<th align="right">months_waited_id</th>
<th align="right">treatments</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1413.429</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">1429.429</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0</td>
<td align="right">1484.571</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0</td>
<td align="right">1384.857</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">0</td>
<td align="right">1570.286</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">0</td>
<td align="right">1558.857</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">0</td>
<td align="right">1851.714</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">0</td>
<td align="right">1663.714</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">0</td>
<td align="right">1577.429</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">0</td>
<td align="right">1493.143</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">0</td>
<td align="right">1465.714</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">0</td>
<td align="right">1458.857</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">incompletes</span> <span class="op">&lt;-</span> <span class="va">calibration_period</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span>,</span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    incompletes <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Example completes data set.</caption>
<thead><tr class="header">
<th align="right">period_id</th>
<th align="right">months_waited_id</th>
<th align="right">incompletes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">28717.71</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">29707.71</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0</td>
<td align="right">30145.71</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0</td>
<td align="right">27426.86</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">0</td>
<td align="right">29318.00</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">0</td>
<td align="right">29889.71</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">0</td>
<td align="right">30338.00</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">0</td>
<td align="right">26303.14</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">0</td>
<td align="right">30080.86</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">0</td>
<td align="right">31047.71</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">0</td>
<td align="right">32260.29</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">0</td>
<td align="right">30302.00</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="generating-the-model-parameters">Generating the model parameters<a class="anchor" aria-label="anchor" href="#generating-the-model-parameters"></a>
</h2>
<p>These inputs are passed into the
<code><a href="../reference/calibrate_capacity_renege_params.html">calibrate_capacity_renege_params()</a></code> function.</p>
<p>For occasions where renege counts are negative for the group of
people that have been waiting 0 months, we can tell the modelling to
assume these are under-reported referrals and redistribute these to
referrals. This is done by setting the
<code>redistribute_m0_reneges</code> to TRUE.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_capacity_renege_params.html">calibrate_capacity_renege_params</a></span><span class="op">(</span></span>
<span>  referrals <span class="op">=</span> <span class="va">referrals</span>,</span>
<span>  completes <span class="op">=</span> <span class="va">completes</span>,</span>
<span>  incompletes <span class="op">=</span> <span class="va">incompletes</span>,</span>
<span>  max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span>,</span>
<span>  redistribute_m0_reneges <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  full_breakdown <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># this can be set to TRUE to see all the transitions for all months waited at each time step</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>The structure of the output from the
<code><a href="../reference/calibrate_capacity_renege_params.html">calibrate_capacity_renege_params()</a></code> function.</caption>
<thead><tr class="header">
<th align="right">months_waited_id</th>
<th align="right">renege_param</th>
<th align="right">capacity_param</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0.1440384</td>
<td align="right">0.0420885</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0.0974161</td>
<td align="right">0.0233166</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0.0891623</td>
<td align="right">0.0167214</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">0.0962514</td>
<td align="right">0.0136003</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">0.1479731</td>
<td align="right">0.0130116</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">0.1150392</td>
<td align="right">0.0136997</td>
</tr>
<tr class="odd">
<td align="right">6</td>
<td align="right">0.1122005</td>
<td align="right">0.0142077</td>
</tr>
<tr class="even">
<td align="right">7</td>
<td align="right">0.1051311</td>
<td align="right">0.0155031</td>
</tr>
<tr class="odd">
<td align="right">8</td>
<td align="right">0.1370721</td>
<td align="right">0.0169077</td>
</tr>
<tr class="even">
<td align="right">9</td>
<td align="right">0.1441040</td>
<td align="right">0.0178851</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">0.1644553</td>
<td align="right">0.0184309</td>
</tr>
<tr class="even">
<td align="right">11</td>
<td align="right">0.2024729</td>
<td align="right">0.0229946</td>
</tr>
<tr class="odd">
<td align="right">12</td>
<td align="right">0.2815010</td>
<td align="right">0.0445286</td>
</tr>
</tbody>
</table>
<p>The renege parameter is a ratio of the mean number of patients that
renege from the stock compared with the mean number entering the stock
by months waited in the calibration period. The capacity parameter is
the same as the renege parameter, but comparing the mean pathways
completed with the mean count of individuals entering the stock.</p>
</div>
<div class="section level2">
<h2 id="validate-these-parameters-on-a-known-time-series">Validate these parameters on a known time series<a class="anchor" aria-label="anchor" href="#validate-these-parameters-on-a-known-time-series"></a>
</h2>
<p>Pass the parameters to a known timeseries, and calculate an
evaluation metric, comparing the predicted count of incomplete pathways
with the known count of incomplete pathways.</p>
<p>The example below calculates the mean absolute percentage error
(MAPE).</p>
<p>First, the data needs constructing. The data required are:</p>
<ol style="list-style-type: decimal">
<li>a vector of capacity per time step</li>
<li>a vector of referrals per time step</li>
<li>a table of counts of incomplete pathways by months waiting for the
time step prior to the first time step of the other two data inputs</li>
</ol>
<p>To create these data we take the full dataset we created earlier and
filter for the validation time period.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">validation_period</span> <span class="op">&lt;-</span> <span class="va">monthly_rtt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span></span>
<span>      <span class="va">period</span>,</span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">calibration_end</span>, unit <span class="op">=</span> <span class="st">"months"</span><span class="op">)</span>, <span class="co"># this helps the user pick up the incompletes from the previous month</span></span>
<span>      <span class="va">validation_end</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">trust</span>,</span>
<span>    <span class="va">period_id</span>,</span>
<span>    <span class="va">type</span>,</span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">validation_referrals</span> <span class="op">&lt;-</span> <span class="va">validation_period</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Referrals"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span></span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">validation_referrals</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 37566 39590 41640 35752 37910 39896</span></span>
<span></span>
<span><span class="va">validation_capacity</span> <span class="op">&lt;-</span> <span class="va">validation_period</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Complete"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span></span>
<span>    <span class="va">count</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">validation_capacity</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5188 5042 5718 5344 5770 6294</span></span>
<span></span>
<span><span class="va">incompletes_at_t0</span> <span class="op">&lt;-</span> <span class="va">validation_period</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    incompletes <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Example of the structure of the incomplete pathways at t=0 that
gets passed into the <code><a href="../reference/apply_params_to_projections.html">apply_params_to_projections()</a></code>
function.</caption>
<thead><tr class="header">
<th align="right">months_waited_id</th>
<th align="right">incompletes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">30302.000</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">27669.714</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">24388.000</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">21297.143</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">15651.429</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">15359.714</td>
</tr>
<tr class="odd">
<td align="right">6</td>
<td align="right">14005.429</td>
</tr>
<tr class="even">
<td align="right">7</td>
<td align="right">11848.286</td>
</tr>
<tr class="odd">
<td align="right">8</td>
<td align="right">9223.714</td>
</tr>
<tr class="even">
<td align="right">9</td>
<td align="right">8165.429</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">6658.857</td>
</tr>
<tr class="even">
<td align="right">11</td>
<td align="right">5682.857</td>
</tr>
<tr class="odd">
<td align="right">12</td>
<td align="right">10859.429</td>
</tr>
</tbody>
</table>
<p>The data are then passed to
<code><a href="../reference/apply_params_to_projections.html">apply_params_to_projections()</a></code> which provides a full table
of stocks at each time step.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validation_performance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_params_to_projections.html">apply_params_to_projections</a></span><span class="op">(</span></span>
<span>  capacity_projections <span class="op">=</span> <span class="va">validation_capacity</span>,</span>
<span>  referrals_projections <span class="op">=</span> <span class="va">validation_referrals</span>,</span>
<span>  incomplete_pathways <span class="op">=</span> <span class="va">incompletes_at_t0</span>,</span>
<span>  renege_capacity_params <span class="op">=</span> <span class="va">params</span>,</span>
<span>  max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<caption>Example of the outputs from the
<code><a href="../reference/apply_params_to_projections.html">apply_params_to_projections()</a></code> function.</caption>
<colgroup>
<col width="11%">
<col width="19%">
<col width="25%">
<col width="10%">
<col width="13%">
<col width="19%">
</colgroup>
<thead><tr class="header">
<th align="right">period_id</th>
<th align="right">months_waited_id</th>
<th align="right">calculated_treatments</th>
<th align="right">reneges</th>
<th align="right">incompletes</th>
<th align="right">input_treatments</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">676.9977</td>
<td align="right">2951.901</td>
<td align="right">26673.101</td>
<td align="right">5188</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="right">443.3309</td>
<td align="right">2467.094</td>
<td align="right">24759.289</td>
<td align="right">5188</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">3</td>
<td align="right">317.8149</td>
<td align="right">2347.379</td>
<td align="right">21722.806</td>
<td align="right">5188</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">4</td>
<td align="right">265.5237</td>
<td align="right">3151.404</td>
<td align="right">17880.215</td>
<td align="right">5188</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">5</td>
<td align="right">205.4543</td>
<td align="right">1800.528</td>
<td align="right">13645.447</td>
<td align="right">5188</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">6</td>
<td align="right">209.1008</td>
<td align="right">1723.367</td>
<td align="right">13427.246</td>
<td align="right">5188</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">7</td>
<td align="right">208.0483</td>
<td align="right">1472.406</td>
<td align="right">12324.974</td>
<td align="right">5188</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">8</td>
<td align="right">191.9510</td>
<td align="right">1624.070</td>
<td align="right">10032.265</td>
<td align="right">5188</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">9</td>
<td align="right">158.0690</td>
<td align="right">1329.174</td>
<td align="right">7736.472</td>
<td align="right">5188</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">10</td>
<td align="right">144.2038</td>
<td align="right">1342.848</td>
<td align="right">6678.377</td>
<td align="right">5188</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">11</td>
<td align="right">146.7154</td>
<td align="right">1348.238</td>
<td align="right">5163.904</td>
<td align="right">5188</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">12</td>
<td align="right">705.8047</td>
<td align="right">4656.671</td>
<td align="right">11179.811</td>
<td align="right">5188</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1514.9857</td>
<td align="right">5410.946</td>
<td align="right">30640.069</td>
<td align="right">5188</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
<td align="right">408.5133</td>
<td align="right">2378.234</td>
<td align="right">23886.354</td>
<td align="right">5042</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">3</td>
<td align="right">308.4222</td>
<td align="right">2383.116</td>
<td align="right">22067.750</td>
<td align="right">5042</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">4</td>
<td align="right">258.8852</td>
<td align="right">3214.391</td>
<td align="right">18249.529</td>
<td align="right">5042</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">5</td>
<td align="right">224.3590</td>
<td align="right">2056.925</td>
<td align="right">15598.930</td>
<td align="right">5042</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">6</td>
<td align="right">177.5700</td>
<td align="right">1531.026</td>
<td align="right">11936.851</td>
<td align="right">5042</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">7</td>
<td align="right">190.6619</td>
<td align="right">1411.621</td>
<td align="right">11824.963</td>
<td align="right">5042</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">8</td>
<td align="right">190.8667</td>
<td align="right">1689.410</td>
<td align="right">10444.697</td>
<td align="right">5042</td>
</tr>
</tbody>
</table>
<p>The mean absolute percentage error (mape) can then be calculated from
this.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate mean absolute percentage error</span></span>
<span><span class="co"># 1. calculate observed incompletes by months waited and period</span></span>
<span><span class="va">observed_incompletes</span> <span class="op">&lt;-</span> <span class="va">validation_period</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    observed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">period_id</span>, <span class="va">months_waited_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    period_id <span class="op">=</span> <span class="va">period_id</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span> <span class="co"># to change the period_ids to the same scale as the ones calculated</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. quantify observed incompletes by months waited and period</span></span>
<span><span class="va">estimated_incompletes</span> <span class="op">&lt;-</span> <span class="va">validation_performance</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="st">"period_id"</span>, </span>
<span>    <span class="st">"months_waited_id"</span>,</span>
<span>    predicted <span class="op">=</span> <span class="st">"incompletes"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. calculate mape</span></span>
<span><span class="va">mape</span> <span class="op">&lt;-</span> <span class="va">observed_incompletes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">estimated_incompletes</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span></span>
<span>      <span class="va">period_id</span>, <span class="va">months_waited_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    absolute_percentage_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span></span>
<span>      <span class="op">(</span><span class="va">predicted</span> <span class="op">-</span> <span class="va">observed</span><span class="op">)</span> <span class="op">/</span> <span class="va">observed</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean_absolute_percentage_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span></span>
<span>      <span class="va">absolute_percentage_error</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">mean_absolute_percentage_error</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mape</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.03814534</span></span></code></pre></div>
<p>The mean absolute error (mae) can also be calculated:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mae</span> <span class="op">&lt;-</span> <span class="va">observed_incompletes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">estimated_incompletes</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span></span>
<span>      <span class="va">period_id</span>, <span class="va">months_waited_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    absolute_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span></span>
<span>      <span class="va">predicted</span> <span class="op">-</span> <span class="va">observed</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean_absolute_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span></span>
<span>      <span class="va">absolute_error</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">mean_absolute_error</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mae</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 522.2354</span></span></code></pre></div>
<p>The mean absolute percentage error for the modelled parameters is
3.8% and the mean absolute error is 522.2.</p>
</div>
<div class="section level2">
<h2 id="future-scenarios">Future scenarios<a class="anchor" aria-label="anchor" href="#future-scenarios"></a>
</h2>
<p>This section describes how to apply the parameters to different
future scenarios. The process is identical to the validation process,
but without the evaluation step (as we are predicting for a time period
with unknown data).</p>
<p>The three scenarios are:</p>
<ol style="list-style-type: decimal">
<li>referrals increasing by 5% and capacity reducing by 5% compared with
the equivalent months in the previous year</li>
<li>referrals decreasing by 5% and capacity increasing by 5% compared
with the equivalent months in the previous year</li>
<li>using a timeseries method (TBATS) to forecast referrals and
capacity</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## Scenario 1 data </span></span>
<span></span>
<span><span class="co"># move the date forward a year and uplift referrals and lower the completed</span></span>
<span><span class="co"># pathways; then filter for the dates of interest</span></span>
<span><span class="va">scenario_1</span> <span class="op">&lt;-</span> <span class="va">monthly_rtt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    period <span class="op">=</span> <span class="va">period</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html" class="external-link">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Referrals"</span> <span class="op">~</span> <span class="va">value</span> <span class="op">*</span> <span class="fl">1.05</span>,</span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Complete"</span> <span class="op">~</span> <span class="va">value</span> <span class="op">*</span> <span class="fl">0.95</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">value</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span></span>
<span>      <span class="va">period</span>,</span>
<span>      <span class="va">prediction_start</span>,</span>
<span>      <span class="va">prediction_end</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># scenario 1 referrals</span></span>
<span></span>
<span><span class="va">scenario_1_referrals</span> <span class="op">&lt;-</span> <span class="va">scenario_1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Referrals"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span></span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_1_capacity</span> <span class="op">&lt;-</span> <span class="va">scenario_1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Complete"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span></span>
<span>    <span class="va">count</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_1_incompletes_at_t0</span> <span class="op">&lt;-</span> <span class="va">scenario_1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    incompletes <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Scenario 2</span></span>
<span></span>
<span><span class="co"># move the date forward a year, uplift completed pathways and lower the</span></span>
<span><span class="co"># referrals; then filter for the dates of interest</span></span>
<span></span>
<span><span class="va">scenario_2</span> <span class="op">&lt;-</span> <span class="va">monthly_rtt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    period <span class="op">=</span> <span class="va">period</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html" class="external-link">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Complete"</span> <span class="op">~</span> <span class="va">value</span> <span class="op">*</span> <span class="fl">1.05</span>,</span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Referrals"</span> <span class="op">~</span> <span class="va">value</span> <span class="op">*</span> <span class="fl">0.95</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">value</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span></span>
<span>      <span class="va">period</span>,</span>
<span>      <span class="va">prediction_start</span>,</span>
<span>      <span class="va">prediction_end</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_2_referrals</span> <span class="op">&lt;-</span> <span class="va">scenario_2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Referrals"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span></span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_2_capacity</span> <span class="op">&lt;-</span> <span class="va">scenario_2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Complete"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span></span>
<span>    <span class="va">count</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_2_incompletes_at_t0</span> <span class="op">&lt;-</span> <span class="va">scenario_2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span>,</span>
<span>    <span class="va">period_id</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">period_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    incompletes <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>For the timeseries data, using tbats, we want a slightly longer
dataset than we have available, so first we download an extra six months
of data to append onto the start of the existing dataset, before doing
the data manipulation prior to the forecasting. This will give us two
years in total.</p>
<p><img src="rtt-pipeline_files/figure-html/tbats-visualisation-1.png" width="672"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># obtain and manipulate tbats data</span></span>
<span><span class="va">additional_start</span> <span class="op">&lt;-</span> <span class="va">calibration_start</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html" class="external-link">%m-%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">additional_end</span> <span class="op">&lt;-</span> <span class="va">calibration_start</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span></span>
<span><span class="co"># each metric must be downloaded separately</span></span>
<span><span class="va">additional_completes</span> <span class="op">&lt;-</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="../reference/get_rtt_data.html">get_rtt_data</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"complete"</span>,</span>
<span>  date_start <span class="op">=</span> <span class="va">additional_start</span>,</span>
<span>  date_end <span class="op">=</span> <span class="va">additional_end</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">additional_incompletes</span> <span class="op">&lt;-</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="../reference/get_rtt_data.html">get_rtt_data</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"incomplete"</span>,</span>
<span>  date_start <span class="op">=</span> <span class="va">additional_start</span>,</span>
<span>  date_end <span class="op">=</span> <span class="va">additional_end</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">additional_referrals</span> <span class="op">&lt;-</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="../reference/get_rtt_data.html">get_rtt_data</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"referral"</span>,</span>
<span>  date_start <span class="op">=</span> <span class="va">additional_start</span>,</span>
<span>  date_end <span class="op">=</span> <span class="va">additional_end</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># append and manipulation</span></span>
<span><span class="va">additional_monthly_rtt</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">additional_completes</span>,</span>
<span>  <span class="va">additional_incompletes</span>,</span>
<span>  <span class="va">additional_referrals</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">trust</span> <span class="op">==</span> <span class="va">analysis_trust</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Non-Admitted"</span> <span class="op">~</span> <span class="st">"Complete"</span>,</span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"Admitted"</span> <span class="op">~</span> <span class="st">"Complete"</span>,</span>
<span>      <span class="va">type</span> <span class="op">==</span> <span class="st">"New Periods"</span> <span class="op">~</span> <span class="st">"Referrals"</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">type</span></span>
<span>    <span class="op">)</span>,</span>
<span>    months_waited_id <span class="op">=</span> <span class="fu"><a href="../reference/convert_months_waited_to_id.html">convert_months_waited_to_id</a></span><span class="op">(</span></span>
<span>      <span class="va">months_waited</span>,</span>
<span>      <span class="va">max_months_waited</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">trust</span>,</span>
<span>      <span class="va">period</span>,</span>
<span>      <span class="va">type</span>,</span>
<span>      <span class="va">months_waited_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span>,</span>
<span>    <span class="va">months_waited_id</span>,</span>
<span>    <span class="va">period</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># here we relate the period_id to the period_id in the monthly_rtt data</span></span>
<span>    <span class="co"># which we will apend this additional data to</span></span>
<span>    period_id <span class="op">=</span> <span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">interval</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">monthly_rtt</span><span class="op">$</span><span class="va">period</span><span class="op">)</span>, <span class="va">period</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">tbats_monthly_rtt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">additional_monthly_rtt</span>,</span>
<span>  <span class="va">monthly_rtt</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span>, <span class="va">months_waited_id</span>, <span class="va">period</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Scenario 3</span></span>
<span></span>
<span><span class="va">forecast_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">rtt_table</span>, <span class="va">number_timesteps</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fcast</span> <span class="op">&lt;-</span> <span class="va">rtt_table</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span>frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/tbats.html" class="external-link">tbats</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">number_timesteps</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">`Point Forecast`</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fcast</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">scenario_3_referrals</span> <span class="op">&lt;-</span> <span class="va">tbats_monthly_rtt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Referrals"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">forecast_function</span><span class="op">(</span></span>
<span>    number_timesteps <span class="op">=</span> <span class="fl">12</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_3_capacity</span> <span class="op">&lt;-</span>  <span class="va">tbats_monthly_rtt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Complete"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">period_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">forecast_function</span><span class="op">(</span></span>
<span>    number_timesteps <span class="op">=</span> <span class="fl">12</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_3_incompletes_at_t0</span> <span class="op">&lt;-</span> <span class="va">tbats_monthly_rtt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">months_waited_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html" class="external-link">group_split</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="va">forecast_function</span>,</span>
<span>    number_timesteps <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># turn the named vector into a two column tibble</span></span>
<span>  <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    months_waited_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    incompletes <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span></code></pre></div>
<p>For each scenario, the data are passed to the
<code><a href="../reference/apply_params_to_projections.html">apply_params_to_projections()</a></code> function and then appended to
each other.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">scenario_1_projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_params_to_projections.html">apply_params_to_projections</a></span><span class="op">(</span></span>
<span>  capacity_projections <span class="op">=</span> <span class="va">scenario_1_capacity</span>,</span>
<span>  referrals_projections <span class="op">=</span> <span class="va">scenario_1_referrals</span>,</span>
<span>  incomplete_pathways <span class="op">=</span> <span class="va">scenario_1_incompletes_at_t0</span>,</span>
<span>  renege_capacity_params <span class="op">=</span> <span class="va">params</span>,</span>
<span>  max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    scenario <span class="op">=</span> <span class="st">"Scenario 1"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_2_projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_params_to_projections.html">apply_params_to_projections</a></span><span class="op">(</span></span>
<span>  capacity_projections <span class="op">=</span> <span class="va">scenario_2_capacity</span>,</span>
<span>  referrals_projections <span class="op">=</span> <span class="va">scenario_2_referrals</span>,</span>
<span>  incomplete_pathways <span class="op">=</span> <span class="va">scenario_2_incompletes_at_t0</span>,</span>
<span>  renege_capacity_params <span class="op">=</span> <span class="va">params</span>,</span>
<span>  max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    scenario <span class="op">=</span> <span class="st">"Scenario 2"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scenario_3_projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_params_to_projections.html">apply_params_to_projections</a></span><span class="op">(</span></span>
<span>  capacity_projections <span class="op">=</span> <span class="va">scenario_3_capacity</span>,</span>
<span>  referrals_projections <span class="op">=</span> <span class="va">scenario_3_referrals</span>,</span>
<span>  incomplete_pathways <span class="op">=</span> <span class="va">scenario_3_incompletes_at_t0</span>,</span>
<span>  renege_capacity_params <span class="op">=</span> <span class="va">params</span>,</span>
<span>  max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    scenario <span class="op">=</span> <span class="st">"Scenario 3"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">scenario_1_projections</span>,</span>
<span>  <span class="va">scenario_2_projections</span>,</span>
<span>  <span class="va">scenario_3_projections</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="st">"period_id"</span>,</span>
<span>    <span class="st">"months_waited_id"</span>,</span>
<span>    value <span class="op">=</span> <span class="st">"incompletes"</span>,</span>
<span>    <span class="st">"scenario"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># here we adjust the period_id field to follow on from the latest period_id in</span></span>
<span>  <span class="co"># the validation dataset (because the apply_params_to_projections function</span></span>
<span>  <span class="co"># resets the earliest period_id to 1)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># 1 is added to the end because the first period is used for the count of</span></span>
<span>    <span class="co"># incomplete pathways at t=0</span></span>
<span>    period_id <span class="op">=</span> <span class="va">period_id</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">validation_period</span><span class="op">$</span><span class="va">period_id</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Here is a sample of the projection data:</p>
<table class="table">
<caption>A sample of the projections object.</caption>
<thead><tr class="header">
<th align="right">period_id</th>
<th align="right">months_waited_id</th>
<th align="right">value</th>
<th align="left">scenario</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">20</td>
<td align="right">1</td>
<td align="right">26737.499</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">2</td>
<td align="right">23338.018</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="odd">
<td align="right">20</td>
<td align="right">3</td>
<td align="right">20439.579</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">4</td>
<td align="right">16115.728</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="odd">
<td align="right">20</td>
<td align="right">5</td>
<td align="right">15480.065</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">6</td>
<td align="right">12460.012</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="odd">
<td align="right">20</td>
<td align="right">7</td>
<td align="right">11210.698</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">8</td>
<td align="right">8671.954</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="odd">
<td align="right">20</td>
<td align="right">9</td>
<td align="right">8905.127</td>
<td align="left">Scenario 1</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">10</td>
<td align="right">6159.941</td>
<td align="left">Scenario 1</td>
</tr>
</tbody>
</table>
<p>We need to attach the date onto the data to help visualising it:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">date_lkp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>    <span class="co"># 1 is added to the end because the first period is used for the count of</span></span>
<span>    <span class="co"># incomplete pathways at t=0</span></span>
<span>    from <span class="op">=</span> <span class="va">prediction_start</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html" class="external-link">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    to <span class="op">=</span> <span class="va">prediction_end</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"months"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  period_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>    from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">projections</span><span class="op">$</span><span class="va">period_id</span><span class="op">)</span>,</span>
<span>    to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">projections</span><span class="op">$</span><span class="va">period_id</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">projections</span> <span class="op">&lt;-</span> <span class="va">projections</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">date_lkp</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span></span>
<span>      <span class="va">period_id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This data can now be appended to the observed incomplete pathways
data to visualise how incomplete pathways change by the number of months
waited over the projection period:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">monthly_rtt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="st">"period"</span>, <span class="st">"period_id"</span>, <span class="st">"months_waited_id"</span>, <span class="st">"value"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    scenario <span class="op">=</span> <span class="st">"Observed"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">projections</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    scenario <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">scenario</span> <span class="op">==</span> <span class="st">"Scenario 1"</span> <span class="op">~</span> <span class="st">"%5 increase referrals\n5% decrease capacity"</span>,</span>
<span>      <span class="va">scenario</span> <span class="op">==</span> <span class="st">"Scenario 2"</span> <span class="op">~</span> <span class="st">"%5 increase capacity\n5% decrease referrals"</span>,</span>
<span>      <span class="va">scenario</span> <span class="op">==</span> <span class="st">"Scenario 3"</span> <span class="op">~</span> <span class="st">"TBATS"</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">scenario</span></span>
<span>    <span class="op">)</span>,</span>
<span>    scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>      <span class="va">scenario</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"Observed"</span>,</span>
<span>        <span class="st">"%5 increase referrals\n5% decrease capacity"</span>,</span>
<span>        <span class="st">"%5 increase capacity\n5% decrease referrals"</span>,</span>
<span>        <span class="st">"TBATS"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    months_waited_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>      <span class="va">months_waited_id</span>,</span>
<span>      <span class="st">"months waited"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    months_waited_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>      <span class="va">months_waited_id</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">12</span>, <span class="st">"months waited"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">period</span>,</span>
<span>      y <span class="op">=</span> <span class="va">value</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">months_waited_id</span>, <span class="va">scenario</span><span class="op">)</span>,</span>
<span>      linetype <span class="op">=</span> <span class="va">scenario</span>,</span>
<span>      colour <span class="op">=</span> <span class="va">scenario</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span></span>
<span>    facets <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">months_waited_id</span><span class="op">)</span>,</span>
<span>    scales <span class="op">=</span> <span class="st">"free_y"</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"Incomplete pathways"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Count of incomplete pathways with three future scenarios"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"Scenario"</span>,</span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>      <span class="st">"%5 increase referrals\n5% decrease capacity"</span> <span class="op">=</span> <span class="st">"#D81B60"</span>,</span>
<span>      <span class="st">"%5 increase capacity\n5% decrease referrals"</span> <span class="op">=</span> <span class="st">"#1E88E5"</span>,</span>
<span>      <span class="st">"TBATS"</span> <span class="op">=</span> <span class="st">"#FFC107"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"Scenario"</span>,</span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"solid"</span>,</span>
<span>      <span class="st">"%5 increase referrals\n5% decrease capacity"</span> <span class="op">=</span> <span class="st">"longdash"</span>,</span>
<span>      <span class="st">"%5 increase capacity\n5% decrease referrals"</span> <span class="op">=</span> <span class="st">"longdash"</span>,</span>
<span>      <span class="st">"TBATS"</span> <span class="op">=</span> <span class="st">"longdash"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="rtt-pipeline_files/figure-html/visualise-projections-1.png" width="768"></p>
<p>For additional ways of visualising wait times that have proved
effective, please see the other vignette.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Fox, Richard Wood, Richard Blackwell.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
